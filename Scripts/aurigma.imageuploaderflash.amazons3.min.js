!function(e,t){function n(e,t,n){return n?void(this["_"+e]=t):this["_"+e]}var r=(e.Aurigma||(e.Aurigma={__namespace:!0}))&&(e.Aurigma.ImageUploaderFlash||(e.Aurigma.ImageUploaderFlash={__namespace:!0}));r.language||(r.language={__namespace:!0});var i=r;!function(){function e(e){this.message=e}var t="undefined"!=typeof exports?exports:"undefined"!=typeof self?self:$.global,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";e.prototype=new Error,e.prototype.name="InvalidCharacterError",t.btoa||(t.btoa=function(t){for(var r,i,o=String(t),a=0,s=n,d="";o.charAt(0|a)||(s="=",a%1);d+=s.charAt(63&r>>8-a%1*8)){if(i=o.charCodeAt(a+=.75),i>255)throw new e("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");r=r<<8|i}return d}),t.atob||(t.atob=function(t){var r=String(t).replace(/[=]+$/,"");if(r.length%4==1)throw new e("'atob' failed: The string to be decoded is not correctly encoded.");for(var i,o,a=0,s=0,d="";o=r.charAt(s++);~o&&(i=a%4?64*i+o:o,a++%4)?d+=String.fromCharCode(255&i>>(-2*a&6)):0)o=n.indexOf(o);return d})}(),r.amazonS3Extender=function(e){if(!(this instanceof r.amazonS3Extender))return new r.amazonS3Extender(e);1==e.state()&&i.debug().showError("AmazonS3Extender should be created before uploader initialization."),e.amazonS3Extender(this),this._uploader=e,this._converters=new r.amazonS3Extender.converters,this._converterIndex=-1;var t=this;this._isNeedSecondSignature=!1,e.events().beforeSendRequest().add(function(){return t._onBeforeSendRequest.apply(t,arguments)}),e.events().initComplete().add(function(){return t._onInitComplete.apply(t,arguments)}),e.events().beforeUpload().add(function(){return t._onBeforeUpload.apply(t,arguments)}),e.events().error().add(function(){return t._onError.apply(t,arguments)})},r.amazonS3Extender.prototype={__class:!0,predefinedFields:{description:"Description_[itemIndex]",width:"Width_[itemIndex]",height:"Height_[itemIndex]",angle:"Angle_[itemIndex]",sourceName:"SourceName_[itemIndex]",horizontalResolution:"HorizontalResolution_[itemIndex]",verticalResolution:"VerticalResolution_[itemIndex]",sourceFileSize:"SourceSize_[itemIndex]",sourceCreatedDateTime:"SourceCreatedDateTime_[itemIndex]",sourceLastModifiedDateTime:"SourceLastModifiedDateTime_[itemIndex]",sourceCreatedDateTimeLocal:"SourceCreatedDateTimeLocal_[itemIndex]",sourceLastModifiedDateTimeLocal:"SourceLastModifiedDateTimeLocal_[itemIndex]",thumbnailSucceeded:"Thumbnail[converterIndex]Succeeded_[itemIndex]",fileMode:"File[converterIndex]Mode_[itemIndex]",fileSize:"File[converterIndex]Size_[itemIndex]",fileWidth:"File[converterIndex]Width_[itemIndex]",fileHeight:"File[converterIndex]Height_[itemIndex]",fileName:"File[converterIndex]Name_[itemIndex]",packageFileCount:"PackageFileCount",packageIndex:"PackageIndex",packageCount:"PackageCount",packageGuid:"PackageGuid",cropBounds:"CropBounds_[itemIndex]"},_prop:n,bucket:function(e){return this._prop("bucket",e,arguments.length)},accessKeyId:function(e){return this._prop("accessKeyId",e,arguments.length)},region:function(e){return this._prop("region",e,arguments.length)},bucketHostName:function(e){return this._prop("bucketHostName",e,arguments.length)},checkIntegrity:function(e){return this._prop("checkIntegrity",e,arguments.length)},converters:function(e){return 0==arguments.length?this._converters:void this._converters.set(e)},_convertPolicyToObj:function(e){for(var t=JSON.parse(atob(e).replace(/\'/g,'"')),n=null,r={},i=0;i<t.conditions.length;i++){n=t.conditions[i];for(var o in n)r[o]=n[o]}return r},_onBeforeSendRequest:function(e,t,n,r){var i=this._uploader,o=++this._converterIndex%this._converterCount,a=i.metadata(),s="x-amz-meta-",d="html"==this._uploader.type(),l=i.files().get(d?r:0);if(!l)return!0;t=t||l.name(),a.enableAllStandardFields(!1),d&&a.resetCustomFields();var c=this.converters().get(0),u=c?this._convertPolicyToObj(this._isNeedSecondSignature?c.policy2():c.policy()):{};a.addCustomField("x-amz-credential",u["x-amz-credential"]||""),a.addCustomField("x-amz-algorithm",u["x-amz-algorithm"]||""),a.addCustomField("x-amz-date",u["x-amz-date"]||""),a.addCustomField("success_action_status",u.success_action_status||"200"),a.enableStandardField("File[converterIndex]_[itemIndex]",!0),a.renameStandardField("File[converterIndex]_[itemIndex]","file"),this.checkIntegrity()&&(a.enableStandardField("File[converterIndex]HashCodeMD5_[itemIndex]",!0),a.renameStandardField("File[converterIndex]HashCodeMD5_[itemIndex]","Content-MD5"));var h=this.converters().get((o+this._converterCount-1)%this._converterCount).meta();if(h&&h.length>0)for(var p=0,m=h.length;p<m;p++){var g=h[p];g.name&&null!=g.value&&a.removeCustomField(s+g.name)}var f=this.converters().get(o);if(f){var _=f.key()?f.key():"",v=/\$\{fileName\}/gi,x=/\$\{guid\}/gi,S=/\$\{path\}/gi;if(S.test(_)&&d&&(_=_.replace(S,i.files().get(0).relativePath()).replace(/[\\]+|[\/]+/g,"/")),v.test(_)&&(_=_.replace(v,t)),x.test(_)&&d){var y=t.lastIndexOf("."),C=y>-1?t.substr(y,t.length):"";_=_.replace(x,n+C)}a.addCustomField("acl",f.acl()),a.addCustomField("key",_),a.addCustomField("policy",this._isNeedSecondSignature?f.policy2():f.policy()),a.addCustomField("x-amz-signature",this._isNeedSecondSignature?f.signature2():f.signature());var I=f.contentType();null!=I&&""!=I&&a.addCustomField("Content-Type",I),f.cacheControl()&&a.addCustomField("Cache-Control",f.cacheControl()),f.expires()&&a.addCustomField("Expires",f.expires()),f.storageClass()&&a.addCustomField("x-amz-storage-class",f.storageClass());var z=f.meta();if(z&&z.length>0)for(var p=0,m=z.length;p<m;p++){var g=z[p],F=g.name;if(F){var b=z[p].value,E=z[p].field;if(null!=E)if(/exif/i.test(E)&&d){var k=l.exif()[E.replace(/exif/i,"")];a.addCustomField(s+F,"undefined"==typeof k?"":k)}else if(/iptc/i.test(E)&&d){var k=l.iptc()[E];a.addCustomField(s+F,"undefined"==typeof k?"":k)}else a.enableStandardField(E,!0),a.renameStandardField(E,s+F);else null!=b&&a.addCustomField(s+F,b)}}}this._converterIndex=o},_getNowString:function(e){var t=+new Date;t+=e?864e5:0;var n=new Date(t),r=n.getFullYear().toString(),i=(n.getMonth()+1).toString();r+=1==i.length?"0"+i:i;var o=n.getDate().toString();return r+=1==o.length?"0"+o:o},_onInitComplete:function(){var t=this._uploader,n=this.bucketHostName()?this.bucketHostName():this.bucket()+".s3.amazonaws.com",r=t.uploadSettings();r.actionUrl(e.location.protocol+"//"+n+"/"),r.uploadConverterOutputSeparately(!0),r.filesPerPackage(1),"java"==t.type()&&r.enableHeadRequest(!1),r.chunkSize(0),this.region()||i.debug().showError("Now you must specify the region field along with other AmazonS3Extender settings."),"html"==t.type()&&t.metadata().uploadRequestHeaders({})},_onError:function(e,t,n,r,i){403==t&&n.indexOf("Check your key and signing method")>-1&&!this._isNeedSecondSignature&&(this._isNeedSecondSignature=!0,this._uploader.upload())},_onBeforeUpload:function(){this._converterCount=this._uploader.converters().count(),this._converterIndex=-1;for(var e="html"==this._uploader.type(),t=this._uploader.converters(),n=e?"MD5BASE64":"MD5",r=this.checkIntegrity()?n:"",i=0,o=t.count();i<o;i++)t.get(i).hash(r)}},r.amazonS3Extender.prototype.constructor=r.amazonS3Extender,r.amazonS3Extender.converters=function(){return this instanceof r.amazonS3Extender.converters?void(this._list={}):new r.amazonS3Extender.converters},r.amazonS3Extender.converters.prototype={__class:!0,clear:function(){this._list={}},count:function(){var e=0;if(this._list)for(var t in this._list)e++;return e},get:function(e){return this._list[e]||(this._list[e]=new r.amazonS3Extender.fileSettings),this._list[e]},remove:function(e){this._list.splice(e,1)},set:function(e){for(var t=0,n=e.length;t<n;t++){var o=new r.amazonS3Extender.fileSettings,a=e[t];this._list[t]=o;for(var s in a)a.hasOwnProperty&&!a.hasOwnProperty(s)||("function"==typeof o[s]?o[s](a[s]):i.debug().howWarning('$au.amazonS3Extender.fileSettings has not "'+s+'" property.'))}}},r.amazonS3Extender.converters.prototype.constructor=r.amazonS3Extender.converters,r.amazonS3Extender.fileSettings=function(){return this instanceof r.amazonS3Extender.fileSettings?void(this._meta=[]):new r.amazonS3Extender.fileSettings},r.amazonS3Extender.fileSettings.prototype={__class:!0,_prop:n,acl:function(e){return this._prop("acl",e,arguments.length)},key:function(e){return this._prop("key",e,arguments.length)},policy:function(e){return this._prop("policy",e,arguments.length)},signature:function(e){return this._prop("signature",e,arguments.length)},policy2:function(e){return this._prop("policy2",e,arguments.length)},signature2:function(e){return this._prop("signature2",e,arguments.length)},contentType:function(e){return this._prop("contentType",e,arguments.length)},storageClass:function(e){return this._prop("storageClass",e,arguments.length)},cacheControl:function(e){return this._prop("cacheControl",e,arguments.length)},expires:function(e){return this._prop("expires",e,arguments.length)},meta:function(e){return this._prop("meta",e,arguments.length)}},r.amazonS3Extender.fileSettings.prototype.constructor=r.amazonS3Extender.fileSettings,e.$au||"undefined"==typeof i||(e.$au=i),e.$au&&(e.$au.imageUploaderFlash=i.imageUploaderFlash)}(window);